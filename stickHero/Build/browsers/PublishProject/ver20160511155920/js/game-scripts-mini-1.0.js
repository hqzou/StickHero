(function(e,t,n){var r=qc.StickHero={uiEvent:new qc.Signal,GAMEWIDTH:640,PILLARWIDTH:150};r.initGame=function(e,t){t.log.trace("开始游戏"),this.game=t,this.me=new qc.StickHero.Me,this.logicpillar=new qc.StickHero.LogicPillar(e),this.uiEvent.dispatch("onLogicReady")},r.reset=function(){this.me.reset()};var i=qc.StickHero.Me=function(){this.level=1,this._current=0,this._best=0,this.gameOverFlag=!1;var e=qc.StickHero.game;e.storage.get("current")&&(this._current=e.storage.get("current")),e.storage.get("best")&&(this._best=e.storage.get("best"))};i.prototype={},i.prototype.constructor=i,t.defineProperties(i.prototype,{current:{get:function(){return this._current},set:function(e){this._current=e,this.best<e&&(this.best=e)}},best:{get:function(){return this._best},set:function(e){this._best=e;var t=qc.StickHero.game;t.storage.set("best",e),t.storage.save()}}}),i.prototype.reset=function(){var e=this;e.level=1,e.current=0,e.gameOverFlag=!1};var s=function(e){this.id=e.id*1,this.minLv=e.minLv*1,this.maxLv=e.maxLv*1||Infinity,this.thickness=e.thickness*1},o=qc.StickHero.LogicPillar=function(e){e||(e=G.game.assets.load("config")),this.infoList=[],this.infoMap={};var t=e.findSheet("pillar");t&&t.rows.forEach(function(e){this.infoList.push(new s(e))},this)};o.prototype.getInfo=function(e){var t=this.infoMap[e];if(!t){var n=this._find(e);t={thickness:qc.StickHero.PILLARWIDTH},n&&(t.thickness*=n.thickness),this.infoMap[e]=t}return t},o.prototype._find=function(e){for(var t=0,n=this.infoList.length;t<n;t++){var r=this.infoList[t];if(e<r.minLv)continue;if(e>=r.minLv&&e<=r.maxLv)return r}return null};var u=qc.defineBehaviour("qc.StickHero.GameOver",qc.Behaviour,function(){},{restartBtn:qc.Serializer.NODE,current:qc.Serializer.NODE,best:qc.Serializer.NODE});u.prototype.awake=function(){this.addListener(qc.StickHero.uiEvent,function(e){e==="gameOver"&&this.showMenu()},this),this.addListener(this.restartBtn.onClick,this.restart,this)},u.prototype.showMenu=function(){this.gameObject.visible=!0,this.current.text="current    "+qc.StickHero.me.current,this.best.text="best    "+qc.StickHero.me.best},u.prototype.restart=function(){this.gameObject.visible=!1,qc.StickHero.uiEvent.dispatch("restart")};var a=qc.defineBehaviour("qc.StickHero.Main",qc.Behaviour,function(){this.startStick=null},{pillars:qc.Serializer.NODE,player:qc.Serializer.NODE,scoreText:qc.Serializer.NODE,clue:qc.Serializer.NODE});a.prototype.awake=function(){var e=this;e.addListener(qc.StickHero.uiEvent,function(t){(t==="startGame"||t==="restart")&&e.restart()},e),e.addListener(qc.StickHero.uiEvent,function(t,n){t==="onPillarReady"&&e._onPillarReady(n)},e),e.addListener(e.gameObject.onDown,function(){qc.StickHero.uiEvent.dispatch("onDown")},e),e.addListener(e.gameObject.onUp,function(){qc.StickHero.uiEvent.dispatch("onUp")},e),e.addListener(qc.StickHero.uiEvent,function(e){e==="onUp"&&(this.gameObject.interactive=!1)},this),e.addListener(qc.StickHero.uiEvent,function(e,t){e==="success"&&this._onStep(t)},this)},a.prototype._onPillarReady=function(e){this.startPillar=e[0],this.startStick=this.startPillar.stick,this.startStick.activeStick=!0;var t=this.player.getScript("qc.StickHero.Player");t.init(this.startPillar),this.gameObject.interactive=!0},a.prototype.restart=function(e){var t=this;qc.StickHero.reset(),this.scoreText.text=""+qc.StickHero.me._current;var n=t.pillars.parent,r=n.TweenPosition;r.onFinished.addOnce(t.start,t),t.resetCamera(),t.show()},a.prototype.start=function(e){var t=this.pillars.getScript("qc.StickHero.Pillars");t.reset()},a.prototype.resetCamera=function(){var e=this,t=e.pillars.parent,n=t.TweenPosition;n.to=new qc.Point(-t.parent.width*.5,0),n.setCurrToStartValue(),n.resetToBeginning(),n.playForward()},a.prototype.show=function(){this.clue.visible=!0,this.gameObject.visible=!0,this.game.timer.add(3e3,function(){this.clue.visible=!1},this)},a.prototype._onStep=function(e){this._step=e;var t=this.player.getScript("qc.StickHero.Player");t.fall(e),qc.StickHero.me.current++,this.scoreText.text=""+qc.StickHero.me.current,this.adjustPillar();var n=this.pillars.getScript("qc.StickHero.Pillars");n.next();var r=this.pillars.getScript("qc.StickHero.Pillars"),i=r.pillarList;this._onPillarReady(i)},a.prototype.adjustPillar=function(){var e=this.pillars.parent,t=e.getScript("qc.TweenPosition"),n=this._step.gameObject,r=new qc.Point(-n.x-e.parent.width*.5,0);t.to=r.clone(),t.setCurrToStartValue(),t.resetToBeginning(),t.playForward()};var o=qc.defineBehaviour("qc.StickHero.uiPillar",qc.Behaviour,function(){this.stick=null},{stickPrefab:qc.Serializer.PREFAB});o.prototype.init=function(e,t){var n=qc.StickHero.logicpillar.getInfo(t);this.gameObject.width=n.thickness,e===null?this.gameObject.x=0:this.gameObject.x=e.gameObject.x+qc.StickHero.GAMEWIDTH-this.gameObject.width,this.stick||(this.stick=this.createStick()),this.initStick()},o.prototype.createStick=function(){var e=this.game.add.clone(this.stickPrefab,this.gameObject.parent.parent);return e.getScript("qc.StickHero.Stick")},o.prototype.initStick=function(){this.stick.init(this)};var f=qc.defineBehaviour("qc.StickHero.Pillars",qc.Behaviour,function(){this.pillarList=[],qc.StickHero.pillars=this},{pillarPrefab:qc.Serializer.PREFAB});f.prototype.awake=function(){this.addListener(qc.StickHero.uiEvent,function(e){e==="onLogicReady"&&this._init()},this)},f.prototype._init=function(){var e=null;for(var t=0;t<3;t++){var n=this.pillarList[t]||this.createPillar();e?n.init(e,t):n.init(null,t),e=n,this.pillarList[t]=n}qc.StickHero.uiEvent.dispatch("onPillarReady",this.pillarList)},f.prototype.createPillar=function(){var e=this.game.add.clone(this.pillarPrefab,this.gameObject);return e.getScript("qc.StickHero.uiPillar")},f.prototype.next=function(){var e=this.pillarList.shift();this.pillarList.push(e);var t=this.getStep();qc.StickHero.me.level+=1,e.init(t,qc.StickHero.me.level)},f.prototype.reset=function(){this._init()},f.prototype.getStep=function(){return this.pillarList[1]};var l=qc.defineBehaviour("qc.StickHero.Player",qc.Behaviour,function(){this._step=null},{pillars:qc.Serializer.NODE});l.prototype.awake=function(){this.addListener(qc.StickHero.uiEvent,function(e,t){e==="startWalk"&&this.walk(t)},this)},l.prototype.init=function(e){this.gameObject.stop(),this.gameObject.switchParent(e.gameObject),this.gameObject.anchoredX=10,this.gameObject.anchoredY=0,this.gameObject.rotation=0},l.prototype.walk=function(e){var t=this.gameObject.TweenPosition;t.setCurrToStartValue(),t.to=new qc.Point(this.gameObject.parent.width+e.gameObject.height,0);if(t.from.x>=t.to.x)t.to=t.from,t.duration=0;else{var n=t.to.x-t.from.x;t.duration=n*.005}t.onFinished.addOnce(function(){this.walkFinish(e)},this),this.gameObject.playAnimation("walk"),t.resetToBeginning(),t.playForward()},l.prototype.walkFinish=function(e){this.gameObject.stop(),this.gameObject.playAnimation("stop");var t=this.pillars.getScript("qc.StickHero.Pillars").getStep();this._step=t,this.gameObject.switchParent(t.gameObject.parent);if(this.gameObject.x>t.gameObject.x+t.gameObject.width||this.gameObject.x<t.gameObject.x){this.gameObject.switchParent(e.gameObject);var n=e.gameObject.getScripts("qc.TweenRotation");n.forEach(function(e){e.flag==="over"&&(e.onFinished.addOnce(function(){this.gameObject.anchoredY=1500,qc.StickHero.uiEvent.dispatch("gameOver")},this),e.resetToBeginning(),e.playForward())},this);return}qc.StickHero.uiEvent.dispatch("success",t)},l.prototype.fall=function(e){this.init(e)};var r=qc.defineBehaviour("qc.StickHero.Stick",qc.Behaviour,function(){this.increaseFlag=!1,this.activeStick=!1},{});r.prototype.awake=function(){this.addListener(qc.StickHero.uiEvent,function(e){e==="onDown"?this.activeStick&&(this.increaseFlag=!0):e==="onUp"&&this.activeStick&&(this.increaseFlag=!1,this.activeStick=!1,this.stickRotate())},this)},r.prototype.update=function(){this.increaseFlag&&(this.gameObject.height+=10)},r.prototype.init=function(e){this.gameObject.height=0,this.gameObject.rotation=0,this.gameObject.switchParent(e.gameObject),this.gameObject.anchoredX=e.gameObject.width},r.prototype.stickRotate=function(){var e=this.gameObject.getScripts("qc.TweenRotation");e.forEach(function(e){e.flag==="start"&&(e.onFinished.addOnce(this.finishRotate,this),e.resetToBeginning(),e.playForward())},this)},r.prototype.finishRotate=function(){qc.StickHero.uiEvent.dispatch("startWalk",this)};var c=qc.defineBehaviour("qc.StickHero.Welcome",qc.Behaviour,function(){},{title:qc.Serializer.NODE,startBtn:qc.Serializer.NODE,excelConfig:qc.Serializer.EXCELASSET});c.prototype.awake=function(){var e=this;qc.StickHero.initGame(e.excelConfig,e.game),e.addListener(e.startBtn.onClick,e.start,e)},c.prototype.start=function(){var e=this;qc.StickHero.uiEvent.dispatch("startGame"),e.hide()},c.prototype.hide=function(){var e=this;e.gameObject.visible=!1}}).call(this,this,Object)